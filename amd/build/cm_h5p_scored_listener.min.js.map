{"version":3,"file":"cm_h5p_scored_listener.min.js","sources":["../src/cm_h5p_scored_listener.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Theme LearnR - JS code cm_h5p_scored_listener\n *\n * @module     local_dynprogressbar/cm_h5p_scored_listener\n * @copyright  2023 Tina John <tina.john@th-luebeck.de>\n * @copyright  Institut fuer interaktive Systeme der TH LÃ¼beck\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\n\nlet registered = false;\n\n/**\n * Function to intialise and register event listeners for this module.\n */\nexport const init = () => {\n    if (registered) {\n        return;\n    }\n    registered = true;\n\n\n  /**\n  * USED for handleXAPIEvent\n  * Add progress whenever context.id module was not completed on inital load.\n  * @param {event} event from Dispatcher.\n  */\n  const handleXAPIEvent = function (event) {\n    if(event && event.data && event.data.statement && event.data.statement.result) {\n          if(event.data.statement.result.score && event.data.statement.result.score.scaled) {\n              console.log('--externalDispatcher-handleXAPIEvent-',event);\n              // Trigger the custom event\n              var cmcompletedEvent = new CustomEvent('cmcompleted',\n              { detail: { message: 'a course module completed or scored' } });\n              // // Trigger the custom event\n              document.dispatchEvent(cmcompletedEvent);\n              //hideCompletionInfo(this.frameElement);\n          }\n      }\n  };\n\n  const hideCompletionInfo = (eventtarget) => {\n    console.log('eventtarget',eventtarget);\n   // var parentElement = document.querySelector('div[data-region=\"completion-info\"] [id=\"childElementID\"]');\n    var element = eventtarget.closest('div[data-region=\"completion-info\"]');\n    //var element = eventtarget.querySelector('div[data-region=\"completion-info\"]');\n    element.style.visibility = 'hidden';\n    return true;\n  };\n\n\n\n//      Listen to H5P iframe message to get H5P completion statements\n      window.addEventListener('message', function(e) {\n        console.log('---got mail from iframe---', e.data);\n/*         if(e.data.method == 'addProgress') {\n            const [, contextid] = e.data.contextid.split(/\\/(?=[^\\/]+$)/);\n            addProgress(contextid);\n        }\n */\n\n        // iframe is loaded and all namesspaces are load\n        if(e.data && e.data.context) {\n          if(e.data.context == \"h5p\" && e.data.action == \"hello\") {\n            addsh5pdispatcherlistener();\n          }\n        }\n\n        // H5PembedIncore_send_core_xapi_statement_post is added to embed.js in core\n        // no better way found until now\n        if(e.data.context == 'h5p' && e.data.action == \"H5PembedIncore_send_core_xapi_statement_post\") {\n            console.log(\"H5PembedIncore_send_core_xapi_statement_post---received->--addProgressFromCoreData---------\");\n            //dynprbar_action();\n        }\n      });\n\n   /**\n   * addsh5pdispatcherlistener\n   * Add progress whenever context.id module was not completed on inital load.\n   */\n    function addsh5pdispatcherlistener () {\n      //for single H5P in a course if the document.onreadystatechange version is preferred\n      // if(window.document.h5player\n      //   && window.document.h5player.H5P && window.document.h5player.H5P.externalDispatcher) {\n      //   console.log('--externalDispatcher-single-gefunden-1-');\n      //   // delete all listeners from H5P.externalDispatcher to get rid of double executions\n      //   // without function due to error with given function as argument\n      //   window.document.h5player.H5P.externalDispatcher.off('xAPI');\n      //   window.document.h5player.H5P.externalDispatcher.on('xAPI', handleXAPIEvent);\n      // }\n\n\n      // FOLLOWING  WORKING BUT TO early in the event lists - setTimeout is a workaround\n        // document.onreadystatechange: iframe is loaded and all namesspaces are loaded\n        // DOES NOT work for single H5P in a course, thus allow multiple listeners to be removed again\n\n        // document.onreadystatechange = () => {\n        //   if (document.readyState === \"complete\") {\n            // the single H5P\n            if(window.document.h5player\n                 && window.document.h5player.H5P && window.document.h5player.H5P.externalDispatcher) {\n                  console.log('dynprogressbar--externalDispatcher-single-gefunden-aka_docready-');\n\n                  var h5pextlDispatcher = window.document.h5player.H5P.externalDispatcher;\n                    // delete all listeners from H5P.externalDispatcher to get rid of double executions\n                    // without function due to error with given function as argument\n                    window.document.h5player.H5P.externalDispatcher.off('xAPI');\n                    window.document.h5player.H5P.externalDispatcher.on('xAPI', function (event) {\n                    if(event && event.data && event.data.statement && event.data.statement.result) {\n                        if(event.data.statement.result.score && event.data.statement.result.score.scaled) {\n                            console.log('dynprogressbar--externalDispatcher-single--',event);\n\n                             var cmcompletedEvent = new CustomEvent('cmcompleted',\n                            { detail: { message: 'a course module completed or scored' } });\n                            // // Trigger the custom event\n                             document.dispatchEvent(cmcompletedEvent);\n                             hideCompletionInfo(window.document);\n                        }\n                    }\n                });\n\n            } else {\n              // Access the h5pplayer within each window\n              for (var i = 0; i < window.length; i++) {\n                  var currentWindow = window[i];\n                  h5pextlDispatcher = currentWindow.H5P.externalDispatcher;\n                  if (h5pextlDispatcher) {\n                      // Perform actions on the h5pplayer element\n                      console.log(\"dynprogressbar---found h5p in window ---\", h5pextlDispatcher);\n                      // delete all listeners from H5P.externalDispatcher to get rid of double executions\n                      // without function due to error with given function as argument\n                      // tried a lot to make it work with function - no success\n                      currentWindow.H5P.externalDispatcher.off('xAPI');\n                      currentWindow.H5P.externalDispatcher.on('xAPI',handleXAPIEvent.bind(currentWindow));\n                      // works fine but codes to messy\n                      // currentWindow.H5P.externalDispatcher.on('xAPI',\n                      // function (event) {\n                      //   if(event && event.data && event.data.statement && event.data.statement.result) {\n                      //       if(event.data.statement.result.score && event.data.statement.result.score.scaled) {\n                      //           console.log('--externalDispatcher----handle-',event.data.statement.result);\n                      //           var cmcompletedEvent = new CustomEvent('cmcompleted',\n                      //            { detail: { message: 'a course module completed or scored' } });\n                      //           // // Trigger the custom event\n                      //            document.dispatchEvent(cmcompletedEvent);\n                      //            hideCompletionInfo(event.target);\n                      //       }\n                      //   }\n                      // }\n                      //);\n                  } else {\n                      console.log('dynprogressbar--h5playerElement not found');\n                  }\n              }\n            }\n//          }\n//        };\n      }\n\n};\n"],"names":["registered","handleXAPIEvent","event","data","statement","result","score","scaled","console","log","cmcompletedEvent","CustomEvent","detail","message","document","dispatchEvent","window","addEventListener","e","context","action","h5player","H5P","externalDispatcher","h5pextlDispatcher","off","on","eventtarget","closest","style","visibility","i","length","currentWindow","bind","addsh5pdispatcherlistener"],"mappings":";;;;;;;;;IA0BIA,YAAa,gBAKG,QACZA,kBAGJA,YAAa,QAQTC,gBAAkB,SAAUC,UAC7BA,OAASA,MAAMC,MAAQD,MAAMC,KAAKC,WAAaF,MAAMC,KAAKC,UAAUC,QAC9DH,MAAMC,KAAKC,UAAUC,OAAOC,OAASJ,MAAMC,KAAKC,UAAUC,OAAOC,MAAMC,OAAQ,CAC9EC,QAAQC,IAAI,wCAAwCP,WAEhDQ,iBAAmB,IAAIC,YAAY,cACvC,CAAEC,OAAQ,CAAEC,QAAS,yCAErBC,SAASC,cAAcL,oBAkB/BM,OAAOC,iBAAiB,WAAW,SAASC,GAC1CV,QAAQC,IAAI,6BAA8BS,EAAEf,MAQzCe,EAAEf,MAAQe,EAAEf,KAAKgB,SACG,OAAlBD,EAAEf,KAAKgB,SAAqC,SAAjBD,EAAEf,KAAKiB,sBAoChCJ,OAAOF,SAASO,UACXL,OAAOF,SAASO,SAASC,KAAON,OAAOF,SAASO,SAASC,IAAIC,mBAAoB,CACnFf,QAAQC,IAAI,wEAERe,kBAAoBR,OAAOF,SAASO,SAASC,IAAIC,mBAGnDP,OAAOF,SAASO,SAASC,IAAIC,mBAAmBE,IAAI,QACpDT,OAAOF,SAASO,SAASC,IAAIC,mBAAmBG,GAAG,QAAQ,SAAUxB,UAClEA,OAASA,MAAMC,MAAQD,MAAMC,KAAKC,WAAaF,MAAMC,KAAKC,UAAUC,QAChEH,MAAMC,KAAKC,UAAUC,OAAOC,OAASJ,MAAMC,KAAKC,UAAUC,OAAOC,MAAMC,OAAQ,CAC9EC,QAAQC,IAAI,8CAA8CP,WAErDQ,iBAAmB,IAAIC,YAAY,cACxC,CAAEC,OAAQ,CAAEC,QAAS,yCAEpBC,SAASC,cAAcL,kBA1EtBiB,YA2EkBX,OAAOF,SA1EnDN,QAAQC,IAAI,cAAckB,aAEZA,YAAYC,QAAQ,sCAE1BC,MAAMC,WAAa,SALDH,IAAAA,wBAkFX,IAAII,EAAI,EAAGA,EAAIf,OAAOgB,OAAQD,IAAK,KAChCE,cAAgBjB,OAAOe,IAC3BP,kBAAoBS,cAAcX,IAAIC,qBAGlCf,QAAQC,IAAI,2CAA4Ce,mBAIxDS,cAAcX,IAAIC,mBAAmBE,IAAI,QACzCQ,cAAcX,IAAIC,mBAAmBG,GAAG,OAAOzB,gBAAgBiC,KAAKD,iBAiBpEzB,QAAQC,IAAI,8CAtFtB0B,GAMiB,OAAlBjB,EAAEf,KAAKgB,SAAqC,gDAAjBD,EAAEf,KAAKiB,QACjCZ,QAAQC,IAAI"}